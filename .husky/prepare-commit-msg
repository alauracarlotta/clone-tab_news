# Quando o commit √© normal, $2 (COMMIT_SOURCE) vem vazio
# Quando o commit √© amend, $2 = amend
# Quando √© commit autom√°tico, $3 tem hash

# TODO

MSG_FILE="$1"
COMMIT_SOURCE="$2"

echo "üî• PREPARE-COMMIT-MSG rodando..."
echo "MSG_FILE: $MSG_FILE"
echo "COMMIT_SOURCE: $COMMIT_SOURCE"

# ------------------------------------------------------
# FORCE NO-EDITOR for the commit process
# ------------------------------------------------------
export GIT_EDITOR=true

# ------------------------------------------------------
# 1Ô∏è‚É£ AMEND ‚Üí deixa editor abrir
# ------------------------------------------------------
if [ "$COMMIT_SOURCE" = "commit" ]; then
  echo "‚ÑπÔ∏è Amend detectado ‚Äî deixando editor"
  export GIT_EDITOR="$(git config --global core.editor)"
  exit 0
fi

# ------------------------------------------------------
# 2Ô∏è‚É£ COMMIT COM -m ‚Üí n√£o mexe
# ------------------------------------------------------
if [ "$COMMIT_SOURCE" = "message" ]; then
  echo "‚ÑπÔ∏è Commit com -m detectado ‚Äî ignorando hook"
  export GIT_EDITOR="$(git config --global core.editor)"
  exit 0
fi

mensagem_vazia() {
  contents=$(grep -vE '^(#|$)' "$MSG_FILE")
  if [ -z "$contents" ]; then
    return 0
  fi
  return 1
}

# ------------------------------------------------------
# 3Ô∏è‚É£ Se ainda N√ÉO tem mensagem ‚Üí chamar cz
# ------------------------------------------------------
if mensagem_vazia; then
  echo "‚ö° Mensagem vazia ‚Äî rodando Commitizen"
  exec < /dev/tty
  npx cz --hook || true
  exit 0
fi

# ------------------------------------------------------
# 4Ô∏è‚É£ Agora tem mensagem ‚Üí sair
# ------------------------------------------------------
echo "‚úî Mensagem preenchida ‚Äî concluindo sem editor"
exit 0
