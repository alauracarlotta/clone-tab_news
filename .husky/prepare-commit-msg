# Quando o commit √© normal, $2 (COMMIT_SOURCE) vem vazio
# Quando o commit √© amend, $2 = amend
# Quando √© commit autom√°tico, $3 tem hash

MSG_FILE="$1"
COMMIT_SOURCE="$2"

echo "üî• PREPARE-COMMIT-MSG rodando..."
echo "MSG_FILE: $MSG_FILE"
echo "COMMIT_SOURCE: $COMMIT_SOURCE"

# ------------------------------------------------------
# 1Ô∏è‚É£ AMEND ‚Üí deixa editor abrir normalmente
# ------------------------------------------------------
if [ "$COMMIT_SOURCE" = "commit" ]; then
  echo "‚ÑπÔ∏è Amend detectado ‚Äî deixando editor"
  exit 0
fi

# ------------------------------------------------------
# 2Ô∏è‚É£ COMMIT COM -m ‚Üí n√£o mexe
# ------------------------------------------------------
if [ "$COMMIT_SOURCE" = "message" ]; then
  echo "‚ÑπÔ∏è Commit com -m detectado ‚Äî ignorando hook"
  exit 0
fi

mensagem_vazia() {
  contents=$(grep -vE '^(#|$)' "$MSG_FILE")
  [ -z "$contents" ]
}

# ------------------------------------------------------
# 3Ô∏è‚É£ Se mensagem ainda est√° vazia ‚Üí chama CZ
# ------------------------------------------------------
if mensagem_vazia; then
  echo "‚ö° Mensagem vazia ‚Äî rodando Commitizen"
  exec < /dev/tty
  npx cz --hook || true
fi

echo "‚úî Finalizando prepare"
exit 0
