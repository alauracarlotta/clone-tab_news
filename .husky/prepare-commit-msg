#!/bin/sh
# Quando o commit √© normal, $2 (COMMIT_SOURCE) vem vazio
# Quando o commit √© amend, $2 = amend
# Quando √© commit autom√°tico, $3 tem hash

#!/bin/sh

MSG_FILE="$1"
COMMIT_SOURCE="$2"

echo "üî• PREPARE-COMMIT-MSG rodando..."
echo "MSG_FILE: $MSG_FILE"
echo "COMMIT_SOURCE: $COMMIT_SOURCE"

# ------------------------------------------------------
# 1Ô∏è‚É£ AMEND ‚Üí deixa editor abrir
# ------------------------------------------------------
if [ "$COMMIT_SOURCE" = "commit" ]; then
  echo "‚ÑπÔ∏è Amend detectado ‚Äî deixando editor"
  exit 0
fi

# ------------------------------------------------------
# 2Ô∏è‚É£ COMMIT COM -m ‚Üí n√£o mexe
# ------------------------------------------------------
if [ "$COMMIT_SOURCE" = "message" ]; then
  echo "‚ÑπÔ∏è Commit com -m detectado ‚Äî ignorando hook"
  exit 0
fi

# Fun√ß√£o pra testar se mensagem est√° vazia de verdade
mensagem_vazia() {
  # remove linhas comentadas e vazias
  contents=$(grep -vE '^(#|$)' "$MSG_FILE")
  if [ -z "$contents" ]; then
    return 0 # est√° vazia
  fi
  return 1 # tem msg v√°lida
}

# ------------------------------------------------------
# 3Ô∏è‚É£ Se ainda N√ÉO tem mensagem v√°lida ‚Üí rodar commitizen
# ------------------------------------------------------
if mensagem_vazia; then
  echo "‚ö° Mensagem vazia ‚Äî rodando Commitizen"
  exec < /dev/tty
  npx cz --hook || true
  exit 0
fi

# ------------------------------------------------------
# 4Ô∏è‚É£ Se agora tem msg ‚Üí sair sem abrir editor
# ------------------------------------------------------
echo "‚úî Mensagem j√° preenchida ‚Äî finalizando sem editor"
exit 0

